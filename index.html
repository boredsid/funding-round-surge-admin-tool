<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="color-scheme" content="dark" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funding Leaderboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* IBM Plex Mono fallback */
    @font-face {
      font-family: 'IBM Plex Mono';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('https://cdn.jsdelivr.net/gh/IBM/plex@6.0.0/IBM-Plex-Mono/fonts/complete/woff2/IBMPlexMono-Regular.woff2') format('woff2');
    }
    @font-face {
      font-family: 'IBM Plex Mono';
      font-style: normal;
      font-weight: 600;
      font-display: swap;
      src: url('https://cdn.jsdelivr.net/gh/IBM/plex@6.0.0/IBM-Plex-Mono/fonts/complete/woff2/IBMPlexMono-SemiBold.woff2') format('woff2');
    }
    @font-face {
      font-family: 'IBM Plex Mono';
      font-style: normal;
      font-weight: 700;
      font-display: swap;
      src: url('https://cdn.jsdelivr.net/gh/IBM/plex@6.0.0/IBM-Plex-Mono/fonts/complete/woff2/IBMPlexMono-Bold.woff2') format('woff2');
    }

    :root {
      --bg: #000000;
      --panel: #17181b;
      --header: #1f2025;
      --line: #2a2b30;
      --muted: #a1a1aa;
      --text: #f5f5f6;
      --accent: #f4d03f;
      --accent-2: #ffe680;
      --heading: #ffffff;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --hover: rgba(255, 212, 59, .04);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: var(--text);
      background: var(--bg);
      letter-spacing: .2px;
    }

    .wrap { max-width: 1100px; margin: 24px auto 80px auto; padding: 0 16px; }

    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px; }
    .brand { display: flex; align-items: center; gap: 14px; }
    h1 { font-size: 20px; margin: 0; letter-spacing: .6px; color: var(--heading); }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .supabase { color: #3ecf8e; font-weight: 700; }

    /* Buttons */
    .btn { appearance: none; border: 1px dashed var(--line); background: transparent; color: var(--text); padding: 10px 14px; border-radius: 999px; font-weight: 700; letter-spacing: .3px; box-shadow: var(--shadow); cursor: pointer; }
    .btn.hidden { display: none; }

    /* Panels */
    .panel { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); overflow: clip; }

    /* Two-column leaderboard layout */
    .twocol { display: grid; gap: 14px; }
    @media (min-width: 860px) { .twocol { grid-template-columns: 1fr 1fr; } }

    /* Leaderboard table */
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: var(--header); }
    .table th, .table td { padding: 12px 14px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--line); }
    .table th { color: var(--text); font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: .6px; }
    .table tr:hover td { background: var(--hover); }
    .rank-pill { display: inline-grid; place-items: center; width: 28px; height: 28px; border-radius: 999px; background: var(--header); border: 1px solid var(--line); color: var(--accent); font-weight: 700; font-size: 12px; }
    .name-link { cursor: pointer; color: var(--text); text-decoration: none; }
    .name-link:hover { text-decoration: underline; }
    .strike { text-decoration: line-through; text-decoration-thickness: 2px; }

    /* Personal view */
    .grid { display: grid; gap: 14px; padding: 16px; }
    @media (min-width: 800px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card h3 { margin: 0; padding: 14px 16px; border-bottom: 1px solid var(--line); background: var(--header); font-size: 13px; text-transform: uppercase; letter-spacing: .6px; color: var(--muted); }
    .card .body { padding: 16px; }
    .kv { display: grid; grid-template-columns: auto 1fr; gap: 8px 14px; font-size: 14px; }
    .kv .k { color: var(--muted); }
    .plays { display: grid; gap: 10px; }
    .play { display: grid; grid-template-columns: 92px 1fr; gap: 8px 12px; align-items: center; background: var(--header); border: 1px solid var(--line); padding: 10px 12px; border-radius: 12px; }
    .tag { font-size: 11px; font-weight: 700; color: #111; background: var(--accent-2); padding: 4px 8px; border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }

    .hidden { display: none !important; }
    .empty { color: var(--muted); padding: 24px; text-align: center; }

    /* Logos */
    .right { display: flex; align-items: center; gap: 12px; }
    .logos { display: flex; align-items: center; gap: 14px; }
    .logos img { height: 64px; width: auto; border: none; box-shadow: none; border-radius: 0; }
    .logos img[alt="BGC logo"] { height: 32px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div>
          <h1>FUN<span class="strike">DING</span> LEADERBOARD</h1>
          <div class="sub">Powered by <span class="supabase">Supabase</span></div>
        </div>
      </div>
      <div class="right">
        <div class="logos">
          <img src="https://i.ibb.co/vCK5HfJF/BGC-Logo-Final.png" alt="BGC logo" />
          <img src="https://i.ibb.co/CKhtyb4f/Surge-logo.png" alt="Surge logo" />
        </div>
        <button id="toggleView" class="btn hidden">← Back to Leaderboard</button>
      </div>
    </div>

    <!-- Leaderboard View (two tables, dynamic rows; no scrolling) -->
    <div id="leaderboardView" class="twocol">
      <div class="panel">
        <table class="table" id="leftTable">
          <thead>
            <tr>
              <th style="width:80px">Rank</th>
              <th>Name</th>
              <th style="width:160px" class="mono">Funding Raised</th>
            </tr>
          </thead>
          <tbody id="leaderBodyLeft">
            <tr><td colspan="3" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="panel">
        <table class="table" id="rightTable">
          <thead>
            <tr>
              <th style="width:80px">Rank</th>
              <th>Name</th>
              <th style="width:160px" class="mono">Funding Raised</th>
            </tr>
          </thead>
          <tbody id="leaderBodyRight">
            <tr><td colspan="3" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Personal View -->
    <div id="personalView" class="hidden">
      <div class="grid">
        <div class="card">
          <h3>Player Summary</h3>
          <div class="body">
            <div class="kv">
              <div class="k">Name</div><div id="pvName"></div>
              <div class="k">Rank</div><div id="pvRank" class="mono"></div>
              <div class="k">Funding Raised</div><div id="pvPoints" class="mono"></div>
              <div class="k">Plays</div><div id="pvPlaysCount" class="mono"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Plays (most recent first)</h3>
          <div class="body">
            <div id="pvPlays" class="plays"></div>
          </div>
        </div>
      </div>
      <div class="sub" style="margin-top:10px;">Tip: Use the back button above to return to the full leaderboard.</div>
    </div>
  </div>

  <script type="module">
    // --- Supabase config ---
    const SUPABASE_URL = 'https://nzrkeuowsypvtdopzxql.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56cmtldW93c3lwdnRkb3B6eHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNDUwMzAsImV4cCI6MjA3MzkyMTAzMH0.2PT5Um86LrfuOKNE8q0etyo6aU5uqO0s7Z_tczTikPM';
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Tables
    const TABLE_PLAYERS = 'surge-event-players';
    const TABLE_SCORES  = 'surge-event-scores';
    const TABLE_GAMES   = 'surge-event-games';

    // Data caches
    let leader = [];
    let scoresCache = [];
    let gamesById = new Map();
    let selectedPlayerName = '';

    // dynamic rows (no scrolling on leaderboard view)
    let cachedRowsPerTable = null;
    let resizeTimer = null;

    // Utils
    const normalize = s => (s || '').trim().toLowerCase();
    const asInt = v => (v === null || v === undefined || v === '') ? 0 : parseInt(v, 10) || 0;
    const escapeHTML = (str = '') => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    function formatFunding(n) { return asInt(n).toLocaleString('en-US'); }
    function getGameName(id) { return gamesById.get(id) || 'Unknown game'; }

    async function fetchPlayers() {
      const { data, error } = await supabase
        .from(TABLE_PLAYERS)
        .select('player_id, player_name')
        .order('player_name', { ascending: true });
      if (error) throw error; return data || [];
    }

    async function fetchScores() {
      const { data, error } = await supabase
        .from(TABLE_SCORES)
        .select('entry_id, play_id, player_id, game_id, game_score, game_win, overall_score');
      if (error) throw error; return data || [];
    }

    async function fetchGames() {
      const { data, error } = await supabase
        .from(TABLE_GAMES)
        .select('game_id, game_name');
      if (error) throw error; return data || [];
    }

    function buildLeaderboard(players, scores) {
      const totals = new Map();
      for (const s of scores) {
        totals.set(s.player_id, (totals.get(s.player_id) || 0) + asInt(s.overall_score));
      }
      const rows = players.map(p => ({ player_id: p.player_id, Name: p.player_name, total: totals.get(p.player_id) || 0 }));
      rows.sort((a, b) => (b.total - a.total) || a.Name.localeCompare(b.Name));
      return rows;
    }

    function computeRowsPerTable() {
      // Measure available height from top of leaderboard to bottom of viewport
      const lb = document.getElementById('leaderboardView');
      const leftTable = document.getElementById('leftTable');
      const leftBody = document.getElementById('leaderBodyLeft');
      if (!lb || !leftTable || !leftBody) return 20;

      const containerTop = lb.getBoundingClientRect().top;
      const available = window.innerHeight - containerTop - 24; // breathing room

      // Measure header height
      const theadH = leftTable.tHead ? leftTable.tHead.getBoundingClientRect().height : 36;

      // Create a temporary row to measure precise row height with current fonts/styles
      const temp = document.createElement('tr');
      temp.innerHTML = `
        <td><span class="rank-pill">88</span></td>
        <td>Sample Name</td>
        <td class="mono">9,999</td>`;
      temp.style.visibility = 'hidden';
      leftBody.appendChild(temp);
      const rowH = Math.max(1, temp.getBoundingClientRect().height || 40);
      leftBody.removeChild(temp);

      // Rows that fit beneath the header
      const rows = Math.floor((available - theadH - 8) / rowH);
      return Math.max(1, rows || 1);
    }

    function renderLeaderboardDynamic() {
      const leftBody = document.getElementById('leaderBodyLeft');
      const rightBody = document.getElementById('leaderBodyRight');
      leftBody.innerHTML = '';
      rightBody.innerHTML = '';

      const rowsPerTable = computeRowsPerTable();
      cachedRowsPerTable = rowsPerTable;

      const maxItems = rowsPerTable * 2; // two tables
      const rows = leader.map((p, idx) => ({ ...p, __rank: idx + 1 })).slice(0, maxItems);

      if (!rows.length) {
        leftBody.innerHTML = `<tr><td colspan="3" class="empty">No players found.</td></tr>`;
        rightBody.innerHTML = `<tr><td colspan="3" class="empty">—</td></tr>`;
        return;
      }

      const leftRows = rows.slice(0, rowsPerTable);
      const rightRows = rows.slice(rowsPerTable, rowsPerTable * 2);

      for (const p of leftRows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="rank-pill">${p.__rank}</span></td>
          <td><a class="name-link" data-name="${encodeURIComponent(p['Name'])}">${p['Name']}</a></td>
          <td class="mono">${formatFunding(p.total)}</td>
        `;
        tr.querySelector('.name-link').addEventListener('click', () => openPersonalView(p['Name']));
        leftBody.appendChild(tr);
      }
      for (const p of rightRows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="rank-pill">${p.__rank}</span></td>
          <td><a class="name-link" data-name="${encodeURIComponent(p['Name'])}">${p['Name']}</a></td>
          <td class="mono">${formatFunding(p.total)}</td>
        `;
        tr.querySelector('.name-link').addEventListener('click', () => openPersonalView(p['Name']));
        rightBody.appendChild(tr);
      }
    }

    function setOverflowHiddenForLeaderboard(on) {
      const val = on ? 'hidden' : '';
      document.documentElement.style.overflow = val;
      document.body.style.overflow = val;
    }

    function handleResize() {
      if (!document.getElementById('leaderboardView').classList.contains('hidden')) {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const before = cachedRowsPerTable;
          renderLeaderboardDynamic();
          if (cachedRowsPerTable !== before) setOverflowHiddenForLeaderboard(true);
        }, 120);
      }
    }
    window.addEventListener('resize', handleResize);

    function openPersonalView(name) {
      const idx = leader.findIndex(p => normalize(p['Name']) === normalize(name));
      if (idx === -1) return;
      const row = leader[idx];
      const rank = idx + 1;
      selectedPlayerName = row['Name'];

      document.getElementById('pvName').textContent   = row['Name'];
      document.getElementById('pvRank').textContent   = `#${rank}`;
      document.getElementById('pvPoints').textContent = formatFunding(row.total);

      const myScores = scoresCache.filter(s => s.player_id === row.player_id);
      document.getElementById('pvPlaysCount').textContent = String(myScores.length);

      const playsEl = document.getElementById('pvPlays');
      playsEl.innerHTML = '';
      const display = [...myScores].reverse();
      if (!display.length) {
        playsEl.innerHTML = `<div class="empty">No plays recorded yet.</div>`;
      } else {
        display.forEach((s, i) => {
          const gameName = escapeHTML(getGameName(s.game_id));
          const div = document.createElement('div');
          div.className = 'play';
          div.innerHTML = `
            <div><span class="tag">Play ${display.length - i}</span></div>
            <div>
              <div><strong>Game:</strong> ${gameName}</div>
              <div class="mono" style="margin-top:4px;"><strong>Overall:</strong> ${asInt(s.overall_score)}${s.game_score!=null?` · <strong>Game Score:</strong> ${asInt(s.game_score)}`:''}${s.game_win!=null?` · <strong>Win:</strong> ${s.game_win?'Yes':'No'}`:''}</div>
            </div>
          `;
          playsEl.appendChild(div);
        });
      }

      document.getElementById('leaderboardView').classList.add('hidden');
      document.getElementById('personalView').classList.remove('hidden');
      document.getElementById('toggleView').classList.remove('hidden');
      setOverflowHiddenForLeaderboard(false);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function backToLeaderboard() {
      document.getElementById('personalView').classList.add('hidden');
      document.getElementById('leaderboardView').classList.remove('hidden');
      document.getElementById('toggleView').classList.add('hidden');
      renderLeaderboardDynamic();
      setOverflowHiddenForLeaderboard(true);
    }

    async function loadAll() {
      try {
        document.getElementById('leaderBodyLeft').innerHTML = `<tr><td colspan="3" class="empty">Loading…</td></tr>`;
        document.getElementById('leaderBodyRight').innerHTML = `<tr><td colspan="3" class="empty">Loading…</td></tr>`;

        const [players, scores, games] = await Promise.all([
          fetchPlayers(),
          fetchScores(),
          fetchGames(),
        ]);

        scoresCache = scores;
        gamesById = new Map(games.map(g => [g.game_id, g.game_name]));
        leader = buildLeaderboard(players, scores);
        renderLeaderboardDynamic();
        setOverflowHiddenForLeaderboard(true);

        // If personal view was open, re-open same player after reload
        const pvVisible = !document.getElementById('personalView').classList.contains('hidden');
        if (pvVisible && selectedPlayerName) {
          const exists = leader.some(p => normalize(p['Name']) === normalize(selectedPlayerName));
          if (exists) openPersonalView(selectedPlayerName); else backToLeaderboard();
        }

        // ---------------------------
        // Simple runtime tests (console)
        // ---------------------------
        runSelfTests();
      } catch (err) {
        console.error(err);
        document.getElementById('leaderBodyLeft').innerHTML = `<tr><td colspan="3" class="empty">Failed to load from Supabase.</td></tr>`;
        document.getElementById('leaderBodyRight').innerHTML = `<tr><td colspan="3" class="empty">Check URL, anon key, table names & RLS policies.</td></tr>`;
      }
    }

    // --- Auto-refresh every 60s (with safeguards) ---
    let refreshTimer = null;
    let refreshInFlight = false;

    function startAutoRefresh() {
      // clear any previous timer (hot reload / multiple inits safety)
      if (refreshTimer) clearInterval(refreshTimer);

      refreshTimer = setInterval(async () => {
        // Don't refetch if tab is hidden or a refresh is already running
        if (document.hidden || refreshInFlight) return;

        refreshInFlight = true;
        try {
          await loadAll();
        } finally {
          refreshInFlight = false;
        }
      }, 60_000); // 60s
    }

    // Refresh once when user returns to the tab or comes back online
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) loadAll();
    });
    window.addEventListener('online', loadAll);

    // Optional: clean up if you ever tear down the page
    window.addEventListener('beforeunload', () => {
      if (refreshTimer) clearInterval(refreshTimer);
    });


    // Back button
    document.getElementById('toggleView').addEventListener('click', backToLeaderboard);

    // Initial load
    loadAll().finally(startAutoRefresh);

    // ---------------------------
    // Test helpers
    // ---------------------------
    function countRows(el) {
      return el ? el.querySelectorAll('tr').length : 0;
    }

    function hasVerticalScroll() {
      const doc = document.documentElement;
      return doc.scrollHeight - 1 > window.innerHeight; // small tolerance
    }

    function runSelfTests() {
      try {
        const rpt = computeRowsPerTable();
        console.assert(Number.isInteger(rpt) && rpt >= 1, 'Rows per table should be >= 1');

        // Only test scroll when leaderboard is visible
        const lbVisible = !document.getElementById('leaderboardView').classList.contains('hidden');
        if (lbVisible) {
          console.assert(!hasVerticalScroll(), 'Leaderboard view should not vertically scroll');
        }

        const leftCnt = countRows(document.getElementById('leaderBodyLeft'));
        const rightCnt = countRows(document.getElementById('leaderBodyRight'));
        const totalCnt = leftCnt + rightCnt;
        console.assert(leftCnt <= rpt && rightCnt <= rpt, 'Each table should render at most rowsPerTable rows');
        console.assert(totalCnt <= rpt * 2, 'Total rows should be at most 2 * rowsPerTable');
      } catch (e) {
        console.warn('Self-tests encountered an issue:', e);
      }
    }
  </script>
</body>
</html>